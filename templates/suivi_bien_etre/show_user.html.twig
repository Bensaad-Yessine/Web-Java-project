{% extends 'base.html.twig' %}

{% block title %}Suivis Bien-Ãªtre - {{ user.nom }} {{ user.prenom }}{% endblock %}

{% block body %}
<style>
  /* Table borders visibles */
  table {
    border-collapse: collapse !important;
    background-color: #ffffff;
  }

  table th,
  table td {
    border: 2px solid #2c3e50 !important;
    vertical-align: middle;
    text-align: center;
  }

  table thead th {
    background-color: #2c3e50 !important;
    color: #ffffff !important;
    font-weight: 800;
  }

  table tbody td {
    font-weight: 600;
  }

  /* Actions buttons alignment */
  .actions-col .btn {
    width: 44px;
  }
</style>

<style>
  .table thead th { font-weight: 800; }
  .table tbody td { font-weight: 600; }
  .actions-col .btn { width: 44px; }
</style>

<div class="container py-4">

  {# Header #}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h3 class="mb-1">ğŸ“Œ Suivis bien-Ãªtre</h3>
      <div class="text-muted">
        <strong>{{ user.nom }} {{ user.prenom }}</strong>
        <span class="mx-2">â€¢</span>
        <span>Utilisateur #{{ user.id }}</span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="{{ path('app_suivi_bien_etre_add', { idUser: idUser }) }}" class="btn btn-success shadow-sm">
        â• Ajouter un suivi
      </a>
      <a href="{{ path('app_user_index') }}" class="btn btn-outline-secondary shadow-sm">
        â†© Retour utilisateurs
      </a>
    </div>
  </div>

  {# Stats (only total + last date) #}
  {% set total = suivis|length %}
  {% set latest = total > 0 ? suivis[0] : null %}

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Total suivis</div>
              <div class="display-6 fw-semibold mb-0">{{ total }}</div>
            </div>
            <div class="badge bg-dark-subtle text-dark">ğŸ“š</div>
          </div>
          <div class="mt-3 text-muted small">
            Dernier ajout :
            <strong>{{ latest and latest.dateSaisie ? latest.dateSaisie|date('d/m/Y') : 'â€”' }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Table #}
  <div class="card shadow-sm border-0">
    <div class="card-header bg-white border-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div class="fw-semibold">ğŸ“‹ Liste des suivis</div>
      <div class="text-muted small">Cliquez âœï¸ pour modifier ou ğŸ—‘ pour supprimer.</div>
    </div>

    <div class="card-body p-0">
      {% if suivis is empty %}
        <div class="p-4 text-center">
          <div class="alert alert-info mb-0">
            Aucun suivi enregistrÃ© pour cet utilisateur.
          </div>
        </div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th style="width:120px;">Date</th>
                <th>Humeur</th>
                <th class="text-center" style="width:120px;">Sommeil</th>
                <th class="text-center" style="width:120px;">Ã‰nergie</th>
                <th class="text-center" style="width:120px;">Stress</th>
                <th class="text-center" style="width:170px;">Score</th>
                <th class="text-center" style="width:90px;">Actions</th>
              </tr>
            </thead>

            <tbody>
            {% for s in suivis %}
              {% set e = s.niveauEnergie ?? null %}
              {% set st = s.niveauStress ?? null %}
              {% set q = s.qualiteSommeil ?? null %}
              {% set score = s.scoreGlobalBienEtre ?? null %}
              {% set pct = score is not null ? (score * 10) : null %}

              <tr>
                <td>{{ s.dateSaisie ? s.dateSaisie|date('d/m/Y') : 'â€”' }}</td>

                <td>
                  <span class="badge bg-info text-dark px-3 py-2">
                    {{ s.humeur ?? 'â€”' }}
                  </span>
                </td>

                <td class="text-center">{{ q is not null ? q : 'â€”' }}</td>
                <td class="text-center">{{ e is not null ? e : 'â€”' }}</td>
                <td class="text-center">{{ st is not null ? st : 'â€”' }}</td>

                {# âœ… SCORE % #}
                <td class="text-center">
                  {% if pct is not null %}
                    <div class="fw-bold">{{ pct }}%</div>
                    <div class="progress mx-auto" style="height:10px; max-width:140px;">
                      <div class="progress-bar {{ pct >= 70 ? 'bg-success' : (pct >= 50 ? 'bg-warning' : 'bg-danger') }}"
                           style="width: {{ pct }}%;"></div>
                    </div>
                    <small class="text-muted fw-semibold">{{ score }}/10</small>
                  {% else %}
                    â€”
                  {% endif %}
                </td>

                {# âœ… ACTIONS (vertical) #}
                <td class="text-center actions-col">
                  <div class="d-flex flex-column align-items-center gap-2">
                    <a href="{{ path('app_suivi_bien_etre_edit', { id: s.id }) }}"
                       class="btn btn-sm btn-warning"
                       title="Modifier">âœï¸</a>

                    <form method="post"
                          action="{{ path('app_suivi_bien_etre_delete', { id: s.id }) }}"
                          onsubmit="return confirm('Supprimer ce suivi ?');">
                      <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ s.id) }}">
                      <button class="btn btn-sm btn-danger" title="Supprimer">ğŸ—‘</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>

          </table>
        </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
