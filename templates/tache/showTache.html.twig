{# templates/tache/showTache.html.twig #}

{% extends 'base.html.twig' %}

{% block title %}Liste des Tâches{% endblock %}

{% block body %}
<div class="main-panel">
  <div class="content-wrapper">

    <h1>Liste des Tâches</h1>

    {# ---------------- Search + Date Filter Form ---------------- #}
    <div class="mb-3 d-flex gap-2 align-items-end">

        {# 1️⃣ Title search form #}
        <form method="get" action="{{ path('tache_search') }}" class="d-flex gap-2 align-items-end">
            <div class="d-flex flex-column">
                <label for="titre">Titre</label>
                <input type="text" id="titre" name="titre" placeholder="Titre..." value="{{ titre|default('') }}" class="form-control">
            </div>
            <div>
                <button type="submit" class="btn btn-primary mt-2">Rechercher</button>
            </div>
        </form>

        {# 2️⃣ Date interval filter form #}
        <form method="get" action="{{ path('tache_filter') }}" class="d-flex gap-2 align-items-end">
            <div class="d-flex flex-column">
                <label for="start">Date début</label>
                <input type="text" id="start" name="start" value="{{ start|default('') }}" class="form-control datepicker" placeholder="dd-mm-yyyy">
            </div>
            <div class="d-flex flex-column">
                <label for="end">Date fin</label>
                <input type="text" id="end" name="end" value="{{ end|default('') }}" class="form-control datepicker" placeholder="dd-mm-yyyy">
            </div>
            <div>
                <button type="submit" class="btn btn-primary mt-2">Filtrer</button>
            </div>
        </form>

    </div>

    {# ---------------- Add Task Button ---------------- #}
    <a href="{{ path('tache_add') }}" class="btn btn-success mb-3">Ajouter une tâche</a>

    {# ---------------- Tasks Table ---------------- #}
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Titre</th>
                    <th>Type</th>
                    <th>Date Début</th>
                    <th>Date Fin</th>
                    <th>Durée</th>
                    <th>Priorité</th>
                    <th>Statut</th>
                    <th>Origine</th>
                    <th>Actions</th>
                    <th>Changer Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for tache in taches %}
                    <tr>
                        <td>{{ tache.id }}</td>
                        <td>{{ tache.titre }}</td>
                        <td>{{ tache.type }}</td>
                        <td>{{ tache.dateDebut ? tache.dateDebut|date('d/m/Y H:i') : '—' }}</td>
                        <td>{{ tache.dateFin ? tache.dateFin|date('d/m/Y H:i') : '—' }}</td>
                        <td>{{ tache.dureeEstimee }} min</td>
                        <td>{{ tache.priorite }}</td>
                        <td>{{ tache.statut }}</td>
                        <td>{{ tache.origine }}</td>
                        <td>
                            <a href="{{ path('tache_edit', {'id': tache.id}) }}" class="btn btn-sm btn-info mb-1">Modifier</a>
                            <form method="post" action="{{ path('tache_delete', {'id': tache.id}) }}" style="display:inline;">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ tache.id) }}">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Voulez-vous vraiment supprimer cette tâche ?');">
                                    Supprimer
                                </button>
                            </form>
                        </td>

                        {# ---------------- Status Change Buttons ---------------- #}
                        <td>
                            <div class="d-flex flex-column gap-1">
                                {% for status in ['A_FAIRE', 'EN_COURS', 'TERMINEE', 'EN_RETARD', 'PAUSED'] %}
                                    {% if status != tache.statut %}
                                        <form method="post" action="{{ path('tache_detail', {'id': tache.id}) }}">
                                            <input type="hidden" name="status" value="{{ status }}">
                                            <button type="submit" class="btn btn-sm btn-primary">{{ status|capitalize }}</button>
                                        </form>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                    </tr>

                    {# ---------------- Task Status History ---------------- #}
                    {% if tache.suivis|length > 0 %}
                        <tr>
                            <td colspan="11">
                                <strong>Historique du statut :</strong>
                                <table class="table table-sm table-bordered mt-1">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Ancien statut</th>
                                            <th>Nouveau statut</th>
                                            <th>Commentaire</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for suivi in tache.suivis %}
                                            <tr>
                                                <td>{{ suivi.dateAction|date('d/m/Y H:i') }}</td>
                                                <td>{{ suivi.ancienStatut }}</td>
                                                <td>{{ suivi.nouveauStatut }}</td>
                                                <td>{{ suivi.commentaire ?: '—' }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    {% endif %}

                {% else %}
                    <tr>
                        <td colspan="11">Aucune tâche trouvée</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

  </div>
</div>
{% endblock %}
